<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload S√°ch</title>
    <link rel="stylesheet" href="/static/CSS/upload.css" />
  </head>
  <body>
    <header>
      <div class="logo">üìö BookUploader</div>
      <nav>
        <button id="btn-upload" class="active">Trang Upload</button>
        <button id="btn-history">L·ªãch S·ª≠ Upload</button>
      </nav>
    </header>

    <!-- Upload Form -->
    <div class="container" id="upload-section">
      <div class="part 1">
        <h2>1. Th√¥ng Tin S√°ch</h2>
        <label>Ti√™u ƒë·ªÅ s√°ch:</label>
        <input type="text" id="title" placeholder="Nh√† Gi·∫£ Kim" />

        <label>T√°c gi·∫£:</label>
        <input type="text" id="author" placeholder="Paulo Coelho" />

        <label>Th·ªÉ lo·∫°i:</label>
        <select id="genre">
          <option>Ti·ªÉu thuy·∫øt</option>
          <option>Khoa h·ªçc</option>
          <option>L·ªãch s·ª≠</option>
          <option>Kinh doanh</option>
          <option>Kh√°c</option>
        </select>

        <label>M√¥ t·∫£ ng·∫Øn / T√≥m t·∫Øt:</label>
        <textarea
          id="summary"
          maxlength="500"
          placeholder="T√≥m t·∫Øt n·ªôi dung s√°ch..."
        ></textarea>

        <label>Ng√¥n ng·ªØ:</label>
        <select id="language">
          <option>Ti·∫øng Vi·ªát</option>
          <option>Ti·∫øng Anh</option>
          <option>Kh√°c</option>
        </select>
      </div>
      <!--p2-->
      <div class="part 2">
        <h2>2. T·ªáp Tin & H√¨nh ·∫¢nh</h2>
        <label>T·∫£i l√™n T·ªáp S√°ch (PDF, EPUB, MOBI ‚â§ 50MB):</label>
        <input type="file" id="book-file" accept=".pdf,.epub,.mobi" />

        <label>T·∫£i l√™n ·∫¢nh B√¨a (JPG, PNG ‚â§ 5MB):</label>
        <input type="file" id="cover-file" accept=".jpg,.jpeg,.png" />
      </div>
      <!--p3-->
      <div class="part 3">
        <h2>3. ƒêi·ªÅu Kho·∫£n & G·ª≠i</h2>
        <div class="checkbox-group">
          <input type="checkbox" id="rights" />
          <label for="rights"
            >T√¥i x√°c nh·∫≠n r·∫±ng t√¥i c√≥ ƒë·∫ßy ƒë·ªß quy·ªÅn ƒë·ªÉ chia s·∫ª v√† xu·∫•t b·∫£n n·ªôi
            dung s√°ch n√†y tr√™n n·ªÅn t·∫£ng.</label
          >
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="terms" />
          <label for="terms"
            >T√¥i ƒë√£ ƒë·ªçc v√† ƒë·ªìng √Ω v·ªõi <a href="#">ƒêi·ªÅu kho·∫£n D·ªãch v·ª•</a> v√†
            <a href="#">Ch√≠nh s√°ch T·∫£i l√™n</a>.</label
          >
        </div>

        <button class="btn-submit" id="upload-btn">
          üì§ T·∫£i L√™n & G·ª≠i Duy·ªát
        </button>
      </div>
    </div>

    <!-- History -->
    <div class="history-container" id="history-section">
      <h2>L·ªãch S·ª≠ Upload</h2>
      <div id="history-list">
        <!-- C√°c s√°ch upload s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
      </div>
    </div>

    <script>
      const btnUpload = document.getElementById("btn-upload");
      const btnHistory = document.getElementById("btn-history");
      const uploadSection = document.getElementById("upload-section");
      const historySection = document.getElementById("history-section");
      const historyList = document.getElementById("history-list");

      // Chuy·ªÉn gi·ªØa 2 trang
      btnUpload.addEventListener("click", () => {
        btnUpload.classList.add("active");
        btnHistory.classList.remove("active");
        uploadSection.style.display = "block";
        historySection.style.display = "none";
      });

      btnHistory.addEventListener("click", async () => {
        btnHistory.classList.add("active");
        btnUpload.classList.remove("active");
        uploadSection.style.display = "none";
        historySection.style.display = "block";

        historyList.innerHTML = "<p>‚è≥ ƒêang t·∫£i l·ªãch s·ª≠...</p>";

        try {
          const res = await fetch("/api/user-history");
          const data = await res.json();

          if (res.ok) {
            if (data.length === 0) {
              historyList.innerHTML =
                "<p>üì≠ Ch∆∞a c√≥ s√°ch n√†o ƒë∆∞·ª£c t·∫£i l√™n.</p>";
              return;
            }

            historyList.innerHTML = "";
            data.forEach((book) => {
              const item = document.createElement("div");
              item.className = "history-item";
              item.innerHTML = `
          <img src="${
            book.cover_image || "/static/images/default.jpg"
          }" alt="b√¨a" width="80">
          <div>
            <h3>${book.title}</h3>
            <p>${book.author}</p>
            <small>${book.created_at}</small>
            <button class="btn-delete" data-id="${book.id}">üóëÔ∏è Xo√°</button>
          </div>
        `;
              historyList.appendChild(item);
            });

            // G√°n s·ª± ki·ªán xo√°
            document.querySelectorAll(".btn-delete").forEach((btn) => {
              btn.addEventListener("click", async () => {
                const id = btn.getAttribute("data-id");
                if (!confirm("Xo√° s√°ch n√†y ch·ª©?")) return;
                const del = await fetch(`/api/delete-book/${id}`, {
                  method: "DELETE",
                });
                const result = await del.json();
                if (del.ok) {
                  alert("‚úÖ Xo√° th√†nh c√¥ng!");
                  btn.closest(".history-item").remove();
                } else alert("‚ùå " + result.error);
              });
            });
          } else {
            historyList.innerHTML = `<p>‚ö†Ô∏è ${
              data.error || "Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠!"
            }</p>`;
          }
        } catch (err) {
          console.error(err);
          historyList.innerHTML = "<p>‚ùå L·ªói khi t·∫£i l·ªãch s·ª≠.</p>";
        }
      });

      // X·ª≠ l√Ω upload
      document
        .getElementById("upload-btn")
        .addEventListener("click", async () => {
          const title = document.getElementById("title").value.trim();
          const author = document.getElementById("author").value.trim();
          const genre = document.getElementById("genre").value;
          const summary = document.getElementById("summary").value;
          const language = document.getElementById("language").value;
          const rightsChecked = document.getElementById("rights").checked;
          const termsChecked = document.getElementById("terms").checked;
          const bookFile = document.getElementById("book-file").files[0];
          const coverFile = document.getElementById("cover-file").files[0];

          // Ki·ªÉm tra ƒë·∫ßu v√†o
          if (!title || !author) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ v√† T√°c gi·∫£!");
            return;
          }
          if (!rightsChecked || !termsChecked) {
            alert("‚ö†Ô∏è B·∫°n c·∫ßn ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n!");
            return;
          }
          if (!bookFile) {
            alert("‚ö†Ô∏è C·∫ßn ch·ªçn file s√°ch (PDF, EPUB, MOBI)!");
            return;
          }

          // Chu·∫©n b·ªã form g·ª≠i
          const formData = new FormData();
          formData.append("title", title);
          formData.append("author", author);
          formData.append("genre", genre);
          formData.append("summary", summary);
          formData.append("language", language);
          formData.append("book_file", bookFile);
          if (coverFile) formData.append("cover_file", coverFile);

          // G·ª≠i ƒë·∫øn Flask
          try {
            const res = await fetch("/api/upload-book", {
              method: "POST",
              body: formData,
            });

            const data = await res.json();
            if (res.ok) {
              alert("‚úÖ Upload th√†nh c√¥ng!");
              console.log("Server tr·∫£ v·ªÅ:", data);

              // ‚úÖ Hi·ªÉn th·ªã ngay s√°ch v·ª´a upload trong l·ªãch s·ª≠
              const item = document.createElement("div");
              item.className = "history-item";
              item.setAttribute("data-id", data.book_id); // ‚úÖ L∆∞u id s√°ch v·ª´a upload

              item.innerHTML = `
        <p><strong>${title}</strong> - ${author}</p>
        <p>üìò T·ªáp s√°ch: ${bookFile.name}</p>
        <p>üñºÔ∏è ·∫¢nh b√¨a: ${coverFile ? coverFile.name : "Kh√¥ng c√≥ ·∫£nh"}</p>
        <button class="btn-delete">Xo√°</button>
      `;

              // üßπ Khi b·∫•m n√∫t "Xo√°"
              item
                .querySelector(".btn-delete")
                .addEventListener("click", async () => {
                  const bookId = item.getAttribute("data-id");
                  if (!bookId) {
                    alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID s√°ch ƒë·ªÉ xo√°!");
                    return;
                  }

                  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s√°ch n√†y kh√¥ng?")) return;

                  try {
                    const res = await fetch(`/api/delete-book/${bookId}`, {
                      method: "DELETE",
                    });
                    const result = await res.json();

                    if (res.ok) {
                      alert("‚úÖ Xo√° th√†nh c√¥ng kh·ªèi DB!");
                      item.remove(); // Xo√° kh·ªèi giao di·ªán
                    } else {
                      alert("‚ùå L·ªói xo√°: " + (result.error || "Kh√¥ng r√µ"));
                    }
                  } catch (err) {
                    console.error("‚ùå L·ªói khi xo√°:", err);
                    alert("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi server khi xo√°!");
                  }
                });

              historyList.prepend(item);

              // Reset form
              document
                .querySelectorAll("input[type='text'], textarea")
                .forEach((el) => (el.value = ""));
              document
                .querySelectorAll("input[type='file']")
                .forEach((el) => (el.value = ""));
              document
                .querySelectorAll("input[type='checkbox']")
                .forEach((el) => (el.checked = false));
            } else {
              alert("‚ùå L·ªói: " + (data.error || "Kh√¥ng r√µ"));
            }
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói k·∫øt n·ªëi t·ªõi server!");
          }
        }); <!-- ‚úÖ ƒë√≥ng ƒë·∫ßy ƒë·ªß h√†m click -->
    </script>
  </body>
</html>
